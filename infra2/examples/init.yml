---

- hosts: all
  sudo: yes
  gather_facts: no

  tasks:

  - name: install git
    apt: name=git state=installed update_cache=yes

- hosts: lb
  sudo: true
  tasks:
    - name: update apt cache
      apt: update_cache=yes cache_valid_time=3600
    - name: install nginx
      apt: name=nginx state=present
    - name: Ngninx configuration
      copy: src=files/default dest=/etc/nginx/sites-enabled/default
      notify:
        - restart nginx

  handlers:
    - name: restart nginx
      service: name=nginx state=restarted

- hosts: frontofficeAPI
  sudo: true
  tasks:
    - name: update apt cache
      apt: update_cache=yes cache_valid_time=3600
    - name: install git
      apt: name=git state=present
    - name: install script for nodejs
      script: home/vagrant/files/setup_node.sh
    - name: install nodejs
      apt: name=nodejs
    - name: clone git repo
      git: repo=https://github.com/Flasheur111/CocktailFinder.git dest=/home/vagrant/CocktailFinder update=no
    - name: install npm modules
      npm: path=/home/vagrant/CocktailFinder/api/
    - name: "Install forever"
      npm: name=forever global=yes state=latest
    - name: "Check list of Node.js apps running."
      command: forever list
      register: forever_list
      changed_when: false
    - name: "Start example Node.js app."
      command: forever start /home/vagrant/CocktailFinder/api/api.js
      when: "forever_list.stdout.find('/home/vagrant/CocktailFinder/api/api.js') == -1"


